<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Contrôler le serveur Minecraft</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f0f0f0;
    }

    h1 {
      color: #333;
    }

    button {
      padding: 10px 20px;
      margin: 10px;
      border: none;
      border-radius: 5px;
      background-color: #007BFF;
      color: white;
      cursor: pointer;
    }

    button:hover {
      background-color: #0056b3;
    }

    pre {
      background-color: #fff;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      overflow-x: auto;
    }

    #serverDetails {
      margin-top: 20px;
    }
  </style>
</head>

<body>
  <form id="serverForm">
    <label for="servers">Sélectionnez un serveur Minecraft :</label>
    <select id="servers" name="servers" onchange="updateServerDetails()">
      <option value="defaut">--</option>
      <!-- Les options des serveurs seront insérées ici dynamiquement -->
    </select>
    <button type="button" onclick="startServer()">Démarrer</button>
    <button type="button" onclick="stopServer()">Arrêter</button>
    <button type="button" onclick="getLogs()">Voir les logs</button>
    <button id="addServerBtn" onclick="addServer()">Ajouter Serveur</button>
  </form>

  <div id="serverDetails">
    <!-- Server details will be displayed here -->
    <h3>Détails du serveur :</h3>
    <p><strong>Nom:</strong> <span id="serverName">Aucun serveur sélectionné</span></p>
    <p><strong>IP:</strong> <span id="serverIP">Non défini</span></p>
    <p><strong>Port:</strong> <span id="serverPort">Non défini</span></p>
  </div>

  <div id="logs" style="display:none;">
    <div id="logContent"></div>
  </div>


  <script>
    // Obtenir la liste des serveurs au chargement de la page
    window.onload = function () {
      fetch('/containers')
        .then(response => response.json())
        .then(data => {
          const select = document.getElementById('servers');
          data.forEach(container => {
            const option = document.createElement('option');
            option.value = container.name;
            option.text = container.name;
            select.appendChild(option);
          });
        });
    };

    function startServer() {
      const server = document.getElementById('servers').value;
      disableButtons(true);  // Disable buttons during the operation
      fetch(`/start/${server}`, { method: 'POST' })
        .then(response => {
          if (response.ok) {
            alert(`Serveur ${server} démarré`);
          }
          disableButtons(false);
        })
        .catch(error => {
          alert('Erreur lors du démarrage du serveur');
          disableButtons(false);
        });
    }

    function stopServer() {
      const server = document.getElementById('servers').value;
      disableButtons(true);  // Disable buttons during the operation
      fetch(`/stop/${server}`, { method: 'POST' })
        .then(response => {
          if (response.ok) {
            alert(`Serveur ${server} arrêté`);
          }
          disableButtons(false);
        })
        .catch(error => {
          alert('Erreur lors de l\'arrêt du serveur');
          disableButtons(false);
        });
    }

    function getLogs() {
      const server = document.getElementById('servers').value;

      const logContainer = document.getElementById('logContent');
      logContainer.textContent = '';  // Clear previous logs
      document.getElementById('logs').style.display = 'block';  // Show log section

      // Create an EventSource to receive the logs
      const eventSource = new EventSource(`/logs/${server}`);

      // Handle incoming logs 
      eventSource.onmessage = function (event) {
        logContainer.textContent += '\n' + event.data;  // Append log data to the content
        logContainer.scrollTop = logContainer.scrollHeight;  // Scroll to bottom
      };

      // Handle connection closed
      eventSource.onclose = function () {
        console.log('Log stream closed');
      };
    }



    function addServer() {
    disableButtons(true); // Désactiver les boutons pendant l'opération

    fetch('/add-server', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        const serverName = data.serverName;
        const containerId = data.containerId;

        // Ajouter directement le serveur à la liste avec un statut de "chargement"
        const select = document.getElementById('servers');
        const option = document.createElement('option');
        option.value = serverName;
        option.textContent = `${serverName} (loading...)`;
        option.dataset.loading = true; // Indiquer qu'il est en cours de chargement
        select.appendChild(option);

        // Vérifier le statut du serveur régulièrement
        checkServerStatus(serverName, containerId, option);

        disableButtons(false);
    })
    .catch(error => {
        alert('Erreur lors de l\'ajout du serveur');
        disableButtons(false);
    });
}


    // Mise à jour des détails du serveur sélectionné
    function updateServerDetails() {
      const server = document.getElementById('servers').value;

      // Requête pour obtenir les détails du serveur
      fetch(`/containers`)
        .then(response => response.json())
        .then(servers => {
          const selectedServer = servers.find(s => s.name === server);
          if (selectedServer) {
            document.getElementById('serverName').textContent = selectedServer.name;
            document.getElementById('serverIP').textContent = selectedServer.ip;
            document.getElementById('serverPort').textContent = selectedServer.port;
          }
        });
    }
    function disableButtons(disabled) {
      const buttons = document.querySelectorAll('button');
      buttons.forEach(button => button.disabled = disabled);
    }

    function checkServerStatus(serverName, containerId, optionElement) {
    const interval = setInterval(() => {
        fetch(`/status/${containerId}`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'running') {
                    // Mettre à jour l'option lorsque le serveur est prêt
                    optionElement.textContent = serverName;
                    optionElement.dataset.loading = false;
                    clearInterval(interval); // Arrêter de vérifier
                } else if (data.status === 'exited') {
                    // Gestion d'erreurs si le conteneur s'arrête
                    optionElement.textContent = `${serverName} (failed to start)`;
                    clearInterval(interval);
                }
            })
            .catch(error => {
                console.error('Erreur lors de la vérification du statut:', error);
                clearInterval(interval);
            });
    }, 5000); // Vérifier toutes les 5 secondes
}

  </script>
</body>

</html>